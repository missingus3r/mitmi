<%- include('../partials/header') %>

<div class="chat-page">
  <div class="container">
    <div class="chat-container">

      <div class="chat-header">
        <% if (match.status === 'matched' && match.photoMatch.bothLiked) { %>
          <img src="<%= otherUser.photo %>" alt="Foto" class="chat-avatar">
          <h2><%= otherUser.name %></h2>
        <% } else { %>
          <div class="chat-avatar-placeholder">?</div>
          <h2>Perfil AnÃ³nimo</h2>
        <% } %>

        <div class="match-info-badge">
          <%= match.compatibilityScore %>% compatible
        </div>
      </div>

      <% if (match.status === 'chatting') { %>
        <div class="chat-actions">
          <button id="requestPhotoReveal" class="btn btn-secondary">
            Â¿Quieres ver las fotos?
          </button>
          <p class="action-hint">Cuando ambos acepten, podrÃ¡n ver sus fotos y decidir si continuar</p>
        </div>
      <% } %>

      <% if (match.status === 'photo_reveal_pending') { %>
        <div class="chat-notification">
          <p>Esperando que ambos acepten revelar las fotos...</p>
        </div>
      <% } %>

      <% if (match.status === 'photo_matching') { %>
        <div class="photo-reveal">
          <h3>Â¡RevelaciÃ³n de fotos!</h3>
          <div class="revealed-photo">
            <img src="<%= otherUser.photo %>" alt="Foto revelada">
          </div>
          <p>Â¿Te gustarÃ­a continuar con esta persona?</p>
          <div class="photo-match-actions">
            <button id="likePhoto" class="btn btn-primary">SÃ­, me gusta</button>
            <button id="dislikePhoto" class="btn btn-secondary">No es para mÃ­</button>
          </div>
        </div>
      <% } %>

      <% if (match.status === 'matched') { %>
        <div class="chat-notification success">
          <p>Â¡Match completo! Ambos se gustaron. ContinÃºen la conversaciÃ³n ðŸ’š</p>
        </div>
      <% } %>

      <% if (match.status === 'rejected') { %>
        <div class="chat-notification error">
          <p>Esta conversaciÃ³n ha terminado. No hubo match en la etapa de fotos.</p>
        </div>
      <% } %>

      <div class="messages-container" id="messagesContainer">
        <% messages.forEach(message => { %>
          <div class="message <%= message.senderId._id.toString() === user._id.toString() ? 'message-sent' : 'message-received' %>">
            <div class="message-content">
              <%= message.content %>
            </div>
            <div class="message-time">
              <%= new Date(message.createdAt).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) %>
            </div>
          </div>
        <% }); %>
      </div>

      <% if (match.status === 'chatting' || match.status === 'matched') { %>
        <div class="message-input-container">
          <div id="typingIndicator" class="typing-indicator" style="display: none;">
            <span>estÃ¡ escribiendo...</span>
          </div>
          <form id="messageForm" class="message-form">
            <input
              type="text"
              id="messageInput"
              placeholder="Escribe un mensaje..."
              autocomplete="off"
              required
            >
            <button type="submit" class="btn btn-primary">Enviar</button>
          </form>
        </div>
      <% } %>

    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const matchId = '<%= match._id %>';
  const userId = '<%= user._id %>';
  const matchStatus = '<%= match.status %>';
</script>
<script src="/js/chat.js"></script>

<%- include('../partials/footer') %>
